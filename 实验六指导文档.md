# 实验六报告

> 学号：<学号>
> 
> 姓名：<姓名>
> 
> 指导老师：<指导老师>
> 
> 实验日期：<20XX-XX-XX>

## 一、实验目的

- 完成实验五中的L/R页面功能；
- 锻炼课堂所讲授的面向对象分析与设计能力；
- 实践编码能力

## 二、实验内容

- 依托教科书的第9章“数据管理”；
- 回顾实验三与实验四内容；
- 结合《课程指导》

完成本次实验。

## 三、实验要求

- Login/Registration System
  - 本次实验要求完成完整的登录/注册功能
- 基本需求
  - 三个UI Pages
    - L/R Page（实验五已进行）
      - 添加一个“角色”选项
        - 用户
        - 管理员
      - 输对用户名和密码后
        - 用户进入Home Page
        - 管理员进入Management Page
      - 如果登录信息不存在，提示进行“注册”
      - 连续3次输错密码后，关闭整个App
    - Registration Page
      - 引导用户输入注册信息
        - 用户名、性别、邮箱、密码、角色为必选项，其他自行设计
        - 需对用户输入内容进行形式判断，如数据类型等
          - 形式判断错误的，需要引导用户重新输入
      - 点击确认按钮后信息存入SQLite数据库
        - “用户”采用HarmonyOS的built-in加密存储功能
        - “管理员”采用自行加密模块处理后存储
    - Management Page
      - 此为管理员登录成功后可进入的页面
      - 具备“查询”按钮，点击返回整个注册数据库的信息
        - 跳转页面后用列表显示出来
          - 需解密后显示明文
  - 完成用例图和详细类图
    - 其他类型的图不要求
  - 完成编码实现
- 技术要求
  - 不能使用回调函数来完成异步编程，全部使用async/await形式
  - 必须有关键节点的日志输出



## 四、实验步骤

### 1. L/R Page

#### 1.1 截图展示

![图片](test1.jpg)

#### 1.2 用例图与类图

![图片](yongli1.jpg)
![图片](lei1.jpg)

#### 1.3 代码实现

<在此处填写你的代码实现（带必要注释及Markdown语法高亮）>

插入代码的语法示例：
```typescript {.line-numbers}
/**
 * 登录页面，处理用户登录逻辑
 */
import { Database } from '../model/Database';
import { Logger } from '../utils/Logger';
import router from '@ohos.router';
import prompt from '@system.prompt';
import common from '@ohos.app.ability.common';

const TAG = 'LoginPage';

@Entry
@Component
struct LoginPage {
  @State username: string = '';       // 用户名
  @State password: string = '';       // 密码
  @State role: string = 'user';       // 角色
  @State errorMessage: string = '';   // 错误信息
  @State loginAttempts: number = 0;   // 登录尝试次数
  @State isLoading: boolean = false;  // 加载状态

  /**
   * 处理登录操作
   */
  async onLogin(): Promise<void> {
    // 表单验证
    if (!this.username.trim() || !this.password.trim()) {
      this.errorMessage = '用户名和密码不能为空';
      prompt.showToast({ message: this.errorMessage });
      return;
    }

    this.isLoading = true;
    this.errorMessage = '';

    try {
      // 获取数据库实例
      const context: common.UIAbilityContext = getContext() as common.UIAbilityContext;
      const db = await Database.getInstance(context);
      // 尝试登录
      const user = await db.login(this.username, this.password);

      if (!user) {
        this.loginAttempts++;
        if (this.loginAttempts >= 3) {
          Logger.warn(TAG, 'Too many failed login attempts');
          prompt.showToast({
            message: '登录失败次数过多，请稍后再试'
          });
          return;
        }
        this.errorMessage = '用户名或密码错误';
        prompt.showToast({ message: this.errorMessage });
        return;
      }

      Logger.info(TAG, `Login successful, role: ${user.role}`);

      // 根据角色跳转到不同页面
      const targetPage = user.role === 'admin' ? 'pages/ManagementPage' : 'pages/HomePage';
      try {
        await router.pushUrl({
          url: targetPage,
          params: { username: this.username } // 可选：传递参数
        });
      } catch (err) {
        Logger.error(TAG, `Navigation error: ${JSON.stringify(err)}`);
        prompt.showToast({ message: '页面跳转失败，请重试' });
      }
    } catch (err) {
      Logger.error(TAG, `Login error: ${JSON.stringify(err)}`);
      this.errorMessage = '登录过程中发生错误';
      prompt.showToast({ message: this.errorMessage });
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * 跳转到注册页面
   */
  onRegister(): void {
    router.pushUrl({ url: 'pages/RegisterPage' })
      .catch((err: Error) => {
        Logger.error(TAG, `Register navigation error: ${JSON.stringify(err)}`);
        prompt.showToast({ message: '无法打开注册页面' });
      });
  }

  build() {
    Column() {
      Text('登录/注册系统')
        .fontSize(24)
        .margin(20);

      // 用户名输入框
      TextInput({ placeholder: '用户名' })
        .width('80%')
        .height(50)
        .margin(10)
        .onChange((value: string) => {
          this.username = value;
        });

      // 密码输入框
      TextInput({ placeholder: '密码' })
        .width('80%')
        .height(50)
        .margin(10)
        .type(InputType.Password)
        .onChange((value: string) => {
          this.password = value;
        });

      // 角色选择
      Row() {
        Radio({ value: 'user', group: 'role' })
          .checked(this.role === 'user')
          .onChange((isChecked: boolean) => {
            if (isChecked) this.role = 'user';
          });
        Text('普通用户')
          .fontSize(16)
          .margin({ left: 8 });

        Radio({ value: 'admin', group: 'role' })
          .checked(this.role === 'admin')
          .onChange((isChecked: boolean) => {
            if (isChecked) this.role = 'admin';
          });
        Text('管理员')
          .fontSize(16)
          .margin({ left: 8 });
      }
      .width('80%')
      .margin(10)
      .justifyContent(FlexAlign.SpaceAround);

      // 错误信息显示
      if (this.errorMessage) {
        Text(this.errorMessage)
          .fontSize(14)
          .fontColor('#ff0000')
          .margin(10);
      }

      // 加载状态显示
      if (this.isLoading) {
        LoadingProgress()
          .width(50)
          .height(50)
          .margin(20);
      } else {
        Button('登录')
          .width('80%')
          .height(50)
          .margin(20)
          .onClick(() => {
            this.onLogin();
          });
      }

      // 注册按钮
      Button('注册新账号')
        .width('80%')
        .height(50)
        .margin(10)
        .onClick(() => {
          this.onRegister();
        });
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center);
  }
}
```


### 2. Registration Page

#### 2.1 截图展示


![图片](test2.jpg)

![图片](test3.jpg)

#### 2.2 用例图与类图

![图片](yongli2.jpg)
![图片](lei2.jpg)

#### 2.3 代码实现

<在此处填写你的代码实现（带必要注释及Markdown语法高亮）>

插入代码的语法示例：
```typescript {.line-numbers}

/**
 * 注册页面，处理新用户注册
 */
import { Database } from '../model/Database';
import { User } from '../model/User';
import { Logger } from '../utils/Logger';
import router from '@ohos.router';
import common from '@ohos.app.ability.common';
import prompt from '@system.prompt';

const TAG = 'RegisterPage';

@Entry
@Component
struct RegisterPage {
  @State username: string = '';       // 用户名
  @State password: string = '';       // 密码
  @State confirmPassword: string = ''; // 确认密码
  @State gender: string = 'male';     // 性别
  @State email: string = '';          // 邮箱
  @State phone: string = '';          // 手机号
  @State role: string = 'user';       // 角色
  @State errorMessage: string = '';   // 错误信息
  @State isLoading: boolean = false;  // 加载状态

  /**
   * 处理注册操作
   */
  async onRegister(): Promise<void> {
    // 表单验证
    if (!this.username.trim() || !this.password.trim() ||
      !this.confirmPassword.trim() || !this.email.trim()) {
      this.errorMessage = '请填写所有必填字段';
      prompt.showToast({ message: this.errorMessage });
      return;
    }

    if (this.password !== this.confirmPassword) {
      this.errorMessage = '两次输入的密码不一致';
      prompt.showToast({ message: this.errorMessage });
      return;
    }

    if (!this.validateEmail(this.email)) {
      this.errorMessage = '请输入有效的邮箱地址';
      prompt.showToast({ message: this.errorMessage });
      return;
    }

    if (this.phone && !this.validatePhone(this.phone)) {
      this.errorMessage = '请输入有效的手机号码';
      prompt.showToast({ message: this.errorMessage });
      return;
    }

    this.isLoading = true;
    this.errorMessage = '';

    try {
      // 获取数据库实例
      const context: common.UIAbilityContext = getContext() as common.UIAbilityContext;
      const db = await Database.getInstance(context);
      // 创建用户对象
      const user = new User(
        this.username,
        this.password,
        this.gender,
        this.email,
        this.role,
        this.phone
      );

      // 注册用户
      const success = await db.registerUser(user);
      if (success) {
        Logger.info(TAG, `User ${this.username} registered successfully`);
        prompt.showToast({ message: '注册成功' });
        router.back();
      } else {
        this.errorMessage = '注册失败，用户名可能已存在';
        prompt.showToast({ message: this.errorMessage });
      }
    } catch (err) {
      Logger.error(TAG, `Registration error: ${JSON.stringify(err)}`);
      this.errorMessage = '注册过程中发生错误';
      prompt.showToast({ message: this.errorMessage });
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * 验证邮箱格式
   * @param email 邮箱地址
   * @returns 是否有效
   */
  validateEmail(email: string): boolean {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
  }

  /**
   * 验证手机号格式
   * @param phone 手机号
   * @returns 是否有效
   */
  validatePhone(phone: string): boolean {
    const re = /^1[3-9]\d{9}$/;
    return re.test(phone);
  }

  build() {
    Column() {
      Text('用户注册')
        .fontSize(24)
        .margin(20);

      // 用户名输入框
      TextInput({ placeholder: '用户名*' })
        .width('80%')
        .height(50)
        .margin(10)
        .onChange((value: string) => {
          this.username = value;
        });

      // 密码输入框
      TextInput({ placeholder: '密码*' })
        .width('80%')
        .height(50)
        .margin(10)
        .type(InputType.Password)
        .onChange((value: string) => {
          this.password = value;
        });

      // 确认密码输入框
      TextInput({ placeholder: '确认密码*' })
        .width('80%')
        .height(50)
        .margin(10)
        .type(InputType.Password)
        .onChange((value: string) => {
          this.confirmPassword = value;
        });

      // 性别选择
      Row() {
        Text('性别*')
          .width(80)
          .fontSize(16);
        Radio({ value: 'male', group: 'gender' })
          .checked(this.gender === 'male')
          .onChange((isChecked: boolean) => {
            if(isChecked) this.gender = 'male';
          });
        Text('男')
          .fontSize(16)
          .margin({ right: 20 });

        Radio({ value: 'female', group: 'gender' })
          .checked(this.gender === 'female')
          .onChange((isChecked: boolean) => {
            if (isChecked) this.gender = 'female';
          });
        Text('女')
          .fontSize(16);
      }
      .width('80%')
      .margin(10);

      TextInput({ placeholder: '邮箱*' })
        .width('80%')
        .height(50)
        .margin(10)
        .onChange((value: string) => {
          this.email = value;
        });

      TextInput({ placeholder: '手机号' })
        .width('80%')
        .height(50)
        .margin(10)
        .onChange((value: string) => {
          this.phone = value;
        });

      Row() {
        Text('角色*')
          .width(80)
          .fontSize(16);
        Radio({ value: 'user', group: 'role' })
          .checked(this.role === 'user')
          .onChange((isChecked: boolean) => {
            if (isChecked) this.role = 'user';
          });
        Text('普通用户')
          .fontSize(16)
          .margin({ right: 20 });

        Radio({ value: 'admin', group: 'role' })
          .checked(this.role === 'admin')
          .onChange((isChecked: boolean) => {
            if (isChecked) this.role = 'admin';
          });
        Text('管理员')
          .fontSize(16);
      }
      .width('80%')
      .margin(10);

      if (this.errorMessage) {
        Text(this.errorMessage)
          .fontSize(14)
          .fontColor('#ff0000')
          .margin(10);
      }

      if (this.isLoading) {
        // 使用ArkUI内置的加载指示器替代方案
        Row() {
          Image($r('app.media.background')) // 使用自定义加载图标
            .width(40)
            .height(40)
            .margin(10);
          Text('注册中...')
            .fontSize(16);
        }
        .width('100%')
        .height(60)
        .justifyContent(FlexAlign.Center)
        .margin(20);
      } else {
        Button('注册')
          .width('80%')
          .height(50)
          .margin(20)
          .onClick(() => {
            this.onRegister();
          });
      }
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center);
  }
}

```
```typescript {.line-numbers}

/**
 * 用户主页，普通用户登录后显示的页面
 */
import router from '@ohos.router';
import { Logger } from '../utils/Logger';
import prompt from '@system.prompt';

const TAG = 'HomePage';

@Entry
@Component
struct HomePage {
  /**
   * 处理退出登录操作
   */
  onLogout() {
    Logger.info(TAG, 'User logged out');
    router.back();
  }

  build() {
    Column() {
      Text('用户主页').fontSize(24).margin(20)
      Text('欢迎回来，普通用户！').fontSize(18).margin(10)

      Button('查看个人信息')
        .width('80%')
        .height(50)
        .margin(10)
        .onClick(() => {
          prompt.showToast({ message: '功能开发中' });
        })

      Button('退出登录')
        .width('80%')
        .height(50)
        .margin(20)
        .onClick(() => {
          this.onLogout();
        })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }
}

```
```typescript {.line-numbers}
/**
 * 用户模型类，表示系统中的用户
 */
export class User {
  id?: number;          // 自增ID
  username: string;     // 用户名
  password: string;     // 加密后的密码
  gender: string;       // 性别
  email: string;        // 邮箱
  role: string;         // 角色(user/admin)
  phone?: string;       // 手机号(可选)
  registerTime?: string; // 注册时间

  /**
   * 构造函数
   * @param username 用户名
   * @param password 密码
   * @param gender 性别
   * @param email 邮箱
   * @param role 角色
   * @param phone 手机号(可选)
   */
  constructor(username: string, password: string, gender: string,
    email: string, role: string, phone?: string) {
    this.username = username;
    this.password = password;
    this.gender = gender;
    this.email = email;
    this.role = role;
    this.phone = phone;
    this.registerTime = new Date().toISOString();
  }
}
```

### 3. Management Page

#### 3.1 截图展示


![图片](test4.jpg)

#### 3.2 用例图与类图

![图片](yongli3.jpg)
![图片](lei3.jpg)

#### 3.3 代码实现

<在此处填写你的代码实现（带必要注释及Markdown语法高亮）>

插入代码的语法示例：
```typescript {.line-numbers}

```
